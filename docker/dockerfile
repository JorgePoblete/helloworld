FROM --platform=$BUILDPLATFORM golang:1.17 as builder

ARG TARGETPLATFORM
ARG TARGETARCH
ARG TARGETOS
ARG BUILDPLATFORM

COPY ./ .

ENV GO111MODULE=on

RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM, with GOOS=$TARGETOS GOARCH=$TARGETARCH"

RUN CGO_ENABLED=0 GOOS=$TARGETOS GOARCH=$TARGETARCH go build -v -o /app main.go

FROM alpine:3.15

WORKDIR /home/user/app/

COPY --from=builder /app .

CMD ["./app"]